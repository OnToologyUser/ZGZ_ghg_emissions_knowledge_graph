@prefix geo: <http://www.opengis.net/ont/geosparql#> .
@prefix geof: <http://www.opengis.net/def/function/geosparql/> .
@prefix mod: <https://w3id.org/mod#> .
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix s4city: <http://www.owl-ontologies.com/s4city#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix usage-o: <http://usage-project.eu/ld/ontology#> .
@prefix usage-s: <http://usage-project.eu/ld/shape/> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix uom: <http://www.opengis.net/def/uom/OGC/1.0/>.


usage-s:GeometryShape a sh:NodeShape;
                      sh:targetClass geo:Geometry.

usage-s:GeometryShape sh:property usage-s:asWKT.
usage-s:asWKT a sh:PropertyShape;
    sh:path geo:asWKT;
    sh:severity sh:Violation;
    sh:datatype geo:wktLiteral;
    sh:maxCount 1.

usage-s:CellShape a sh:NodeShape;
                  sh:targetClass usage-o:Cell.

usage-s:CellShape sh:sparql usage-s:NotInMultipleDistricts.
usage-s:NotInMultipleDistricts a sh:SPARQLConstraint ;
    sh:severity sh:Violation;
    sh:prefixes usage-o:, geo:, geof:, s4city:, xsd:, uom: ;
    sh:message "Cell {$this} is labelled as being within {?district} and {?district2} which is not possible.";
    sh:select """ 
    PREFIX s4city: <https://saref.etsi.org/saref4city/>
    PREFIX geo: <http://www.opengis.net/ont/geosparql#>
    SELECT DISTINCT $this ?district ?district2 WHERE{
    ?district a s4city:District .
    ?district2 a s4city:District .
    $this geo:sfWithin ?district .
    $this geo:sfWithin ?district2 .
    FILTER (?district != ?district2)
    }
    """ .

usage-s:CellShape sh:sparql usage-s:ActuallyWithin.
usage-s:ActuallyWithin a sh:SPARQLConstraint ;
    sh:severity sh:Violation;
    sh:prefixes usage-o:, geo:, geof:, s4city:, xsd:, uom: ;
    sh:message "Cell {$this} is labelled as being within {?district} but its polygon is actually outside the boundaries of the buffered polygon {?bufferWkt}.";
    sh:select """
    PREFIX s4city: <https://saref.etsi.org/saref4city/>
    PREFIX geo: <http://www.opengis.net/ont/geosparql#>
    PREFIX geof: <http://www.opengis.net/def/function/geosparql/>
    PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
    PREFIX uom: <http://www.opengis.net/def/uom/OGC/1.0/>
    SELECT $this ?district (?wkt as ?value) ?districtWkt ?bufferWkt WHERE {
        ?district a s4city:District;
                geo:hasGeometry/geo:asWKT ?districtWkt.
        ?this geo:sfWithin ?district;
            geo:hasGeometry/geo:asWKT ?wkt.
        BIND (geof:buffer(?districtWkt,xsd:double(0.0008),uom:degree) AS ?bufferWkt)
        FILTER (!geof:sfWithin(?wkt,?bufferWkt))
        }
        """.

# Prefixes declaration
usage-o: sh:declare [
sh:prefix "usage-o" ;
sh:namespace "http://usage-project.eu/ld/ontology#"^^xsd:anyURI
] .

geo: sh:declare [
sh:prefix "geo" ;
sh:namespace "http://www.opengis.net/ont/geosparql#"^^xsd:anyURI
] .

geof: sh:declare [
sh:prefix "geof" ;
sh:namespace "http://www.opengis.net/def/function/geosparql/"^^xsd:anyURI
] .

s4city:  sh:declare [
sh:prefix "s4city" ;
sh:namespace "http://www.owl-ontologies.com/s4city#"^^xsd:anyURI
] .

xsd: sh:declare [
sh:prefix "xsd" ;
sh:namespace "http://www.w3.org/2001/XMLSchema#"^^xsd:anyURI
] . 

uom: sh:declare [
sh:prefix "uom" ;
sh:namespace "http://www.opengis.net/def/uom/OGC/1.0/"^^xsd:anyURI
] . 